name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy-manverse:
    runs-on: self-hosted
    steps:
      - name: Pull latest code
        run: |
          cd /var/www/manverse
          git pull origin main

      - name: Rebuild and restart containers
        run: |
          cd /var/www/manverse
          docker compose build backend
          docker compose build frontend
          docker compose up -d

      - name: Run migrations and collectstatic
        run: |
          docker exec manverse_backend python manage.py migrate --no-input
          docker exec manverse_backend python manage.py collectstatic --no-input
          chown -R www-data:www-data /home/manverse/static/
          docker image prune -f